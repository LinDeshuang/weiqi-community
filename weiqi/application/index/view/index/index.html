{extend name="base"/}
{block name="main"}
<div class="container">
	<ul class="nav nav-pills  nav-fill">
	  <li class="nav-item">
	    <a class="nav-link active" href="#">棋谱大厅</a>
	  </li>
	  <li class="nav-item">
	    <a class="nav-link" href="{:url('index/index/notion')}">棋手说</a>
	  </li>
	  </li>
	</ul>
	{foreach name = 'manual_info' item = 'mnl'}
	<div class="card" style="margin: 5px auto;">
	  <div class="card-body">
	    <a href="{:url('index/index/playManual',['id'=>$mnl.id])}">
	    	<h3 class="card-title">{$mnl.manual_name}</h3>
	    </a>
	    <h7 class="card-subtitle mb-2 text-muted">
	    	<i class="fa fa-user"></i>&nbsp;{$mnl.user_name}&nbsp;&nbsp;
	    	<i class="fa fa-eye"></i>&nbsp;{$mnl.click_count}&nbsp;&nbsp;
	    	<i class="fa fa-thumbs-o-up"></i>&nbsp;{$mnl.praise_count}&nbsp;&nbsp;
	    	<i class="fa fa-comment-o"></i>&nbsp;{$mnl.comment_count}
	    </h7>
	    <p class="card-text">{:mb_substr($mnl.manual_intro,0,20)}{if mb_strlen($mnl.manual_intro) > 20 }......{/if}</p>
	    <h7 class="card-subtitle mb-2 text-muted"><i class="fa fa-clock-o"></i>&nbsp;{:date('Y-m-d H:i',$mnl.create_time)}</h7>
	  </div>
	</div>
	{/foreach}
	<section class="alert alert-light text-center" role="alert" id="loadingFlag" style="display: none;"><i class="fa fa-spinner fa-pulse fa-2x fa-fw" ></i>&nbsp;正在加载</section>
</div>
{/block}
{block name='js'}
<script type="text/javascript">
	var page = 2;
	var bodyH = $('body')[0].offsetHeight;
	var isLoading = 0;
	var newDate = new Date();
	$(function(){
		$(window).scroll(function(){
			$('#loadingFlag').css({'display':'block'});
			if(!isLoading)
			{
				var content = '';
				var top = $('#loadingFlag').offset().top;
				var flagH = $('#loadingFlag').height();
				var scrollTop = $(window).scrollTop();
				var viewH = $(window).height();
				
				if( scrollTop+viewH-flagH > top )
				{
					isLoading = 1;
					$.ajax({
						url:'{:url("index/index/index")}'+'?page='+page,
						method:'post',
						dataType:'json',
						success:function(retData){
							var data = retData.data;
							if(data != '')
							{
								for(var i = 0, len = data.length ; i < len ; i++)
								{
									 newDate.setTime(data[i].create_time*1000);
									 content = content + '<div class="card" style="margin: 5px auto;">\
													  <div class="card-body">\
													    <a href="/index/index/playManual?id='+ data[i].id +'">\
													    	<h3 class="card-title">'+ data[i].manual_name +'</h3>\
													    </a>\
													    <h7 class="card-subtitle mb-2 text-muted">\
													    	<i class="fa fa-user"></i>&nbsp;'+ data[i].user_name+'&nbsp;&nbsp;\
													    	<i class="fa fa-eye"></i>&nbsp;'+ data[i].click_count +'&nbsp;&nbsp;\
										    		    	<i class="fa fa-thumbs-o-up"></i>&nbsp;'+data[i].praise_count+'&nbsp;&nbsp;\
	    													<i class="fa fa-comment-o"></i>&nbsp;'+data[i].comment_count+'\
													    </h7>\
													    <p class="card-text">'+ data[i].manual_intro.substring(0,20) + '......</p>\
													    <h7 class="card-subtitle mb-2 text-muted">\
													    <i class="fa fa-clock-o"></i>&nbsp;'+ newDate.format('yyyy-MM-dd h:m') +'</h7>\
													  </div>\
													</div>';
								}
								$(content).insertBefore('#loadingFlag');
								isLoading = 0;
								page = retData.current_page+1;
							}
							else
							{
								$('#loadingFlag').html('这回真没了');
								page--;
							}
							
						}
					});
				}
			}
		})
	})
</script>
{/block}